(window.webpackJsonp=window.webpackJsonp||[]).push([[53],{223:function(t,a,s){"use strict";s.r(a);var n=s(0),e=Object(n.a)({},function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"屏蔽中间件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#屏蔽中间件","aria-hidden":"true"}},[t._v("#")]),t._v(" 屏蔽中间件")]),t._v(" "),s("p",[t._v("除了 CORS 和 CSRF 之外，AdonisJs 还可以防止你的 Web 应用程序受到其他恶意软件攻击，如 "),s("strong",[t._v("XSS, Content Sniffing, Script Injection")]),t._v(" 等。")]),t._v(" "),s("p",[t._v("没有什么可以完全保护你的网站。 AdonisJs 作为一个框架为你提供了一些防止常见 Web 攻击的方法。")]),t._v(" "),s("h2",{attrs:{id:"建立"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#建立","aria-hidden":"true"}},[t._v("#")]),t._v(" 建立")]),t._v(" "),s("p",[t._v("安装 shield 提供程序并注册中间件：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("adonis "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" @adonisjs/shield\n")])])]),s("p",[t._v("接下来，在 start/app.js 文件中注册提供程序：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" providers "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@adonisjs/shield/providers/ShieldProvider'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("p",[t._v("最后，在 start/kernel.js 文件中注册全局中间件：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" globalMiddleware "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Adonis/Middleware/Shield'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("blockquote",[s("p",[t._v("Shield 中间件依赖于会话，因此请确保它们已正确设置。")])]),t._v(" "),s("h2",{attrs:{id:"内容安全政策"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#内容安全政策","aria-hidden":"true"}},[t._v("#")]),t._v(" 内容安全政策")]),t._v(" "),s("p",[t._v("内容安全策略( CSP )可帮助你定义用于加载和执行脚本，样式，字体和各种其他资源的可信来源。")]),t._v(" "),s("p",[t._v("在允许从不同来源执行脚本时严格要求是一种好习惯。")]),t._v(" "),s("p",[t._v("有关更多信息，请阅读 "),s("a",{attrs:{href:"http://www.html5rocks.com/en/tutorials/security/content-security-policy",target:"_blank",rel:"noopener noreferrer"}},[t._v("HTML5 rock"),s("OutboundLink")],1),t._v(" 的这篇文章。")]),t._v(" "),s("h4",{attrs:{id:"配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置","aria-hidden":"true"}},[t._v("#")]),t._v(" 配置")]),t._v(" "),s("p",[t._v("CSP 的配置保存在 config/shield.js 文件中：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("csp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  directives"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    defaultSrc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'self'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://getcdn.com'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    scriptSrc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'self'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@nonce'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    styleSrc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://getbootstrap.com'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    imgSrc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://dropbox.com'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  reportOnly"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  setAllHeaders"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  disableAndroid"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("table",[s("thead",[s("tr",[s("th",[t._v("键")]),t._v(" "),s("th",[t._v("值")]),t._v(" "),s("th",[t._v("描述")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("directives")]),t._v(" "),s("td",[t._v("对象")]),t._v(" "),s("td",[t._v("Directives 可帮助你定义要应用于不同资源类型的策略。你可以从 http://content-security-policy.com 获取所有指令的列表。")])]),t._v(" "),s("tr",[s("td",[t._v("reportOnly")]),t._v(" "),s("td",[t._v("布尔值")]),t._v(" "),s("td",[t._v("将值设置 true 为记录违反某些规则的警告，而不是停止执行页面。")])]),t._v(" "),s("tr",[s("td",[t._v("setAllHeaders")]),t._v(" "),s("td",[t._v("布尔值")]),t._v(" "),s("td",[t._v("Shield 为不同的浏览器设置不同的 HTTP 标头。将值设置 true 为设置所有后备标头，而不管浏览器如何。")])]),t._v(" "),s("tr",[s("td",[t._v("disableAndroid")]),t._v(" "),s("td",[t._v("布尔值")]),t._v(" "),s("td",[t._v("由于已知 Android 有关 CSP 的错误，请将值设置 true 为禁用 Android 的 CSP 。")])])])]),t._v(" "),s("h4",{attrs:{id:"浏览器支持"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#浏览器支持","aria-hidden":"true"}},[t._v("#")]),t._v(" 浏览器支持")]),t._v(" "),s("p",[t._v("几乎所有现代浏览器都支持 CSP 。")]),t._v(" "),s("p",[t._v("以下是支持的浏览器的"),s("a",{attrs:{href:"http://caniuse.com/#feat=contentsecuritypolicy",target:"_blank",rel:"noopener noreferrer"}},[t._v("列表"),s("OutboundLink")],1),t._v("。")]),t._v(" "),s("h4",{attrs:{id:"通过元标记的-csp-策略"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#通过元标记的-csp-策略","aria-hidden":"true"}},[t._v("#")]),t._v(" 通过元标记的 CSP 策略")]),t._v(" "),s("p",[t._v("shield 中间件自动设置为 CSP 工作所需的 HTTP header ，如果需要的话提供了一个视图助手来设置 meta 标签：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cspMeta")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("div",{staticClass:"language-html extra-class"},[s("pre",{pre:!0,attrs:{class:"language-html"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("meta")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("http-equiv")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("Content-Security-Policy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("content")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("xxx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),s("p",[t._v("CSP Nonce\n带有内联 JavaScript 代码的脚本标记会自动受到浏览器的信任和执行。")]),t._v(" "),s("p",[t._v("可以通过添加 @nonce 到配置 scriptSrc 数组来停止此行为：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("csp"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  directives"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    scriptSrc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'self'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@nonce'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("要告诉浏览器哪些内联脚本块仍应执行，请在模板中 nonce 使用 cspNonce 视图全局追加属性，如下所示：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("script nonce"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"{{ cspNonce }}"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("script"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),s("h2",{attrs:{id:"恶意软件防护"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#恶意软件防护","aria-hidden":"true"}},[t._v("#")]),t._v(" 恶意软件防护")]),t._v(" "),s("p",[t._v("恶意软件防护有助于保护你的网站免受 XSS 攻击，不需要 iframe embeds, content-type sniffing 并且不让 IE 在你的网页上下文中执行未经请求的脚本。")]),t._v(" "),s("h4",{attrs:{id:"xss"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#xss","aria-hidden":"true"}},[t._v("#")]),t._v(" XSS")]),t._v(" "),s("p",[t._v("编辑 xss 配置对象以 启用/禁用 XSS 保护(设置标头X-XSS-Protection=1; mode=block)：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("xss"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  enabled"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  enableOnOldIE"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h4",{attrs:{id:"no-sniff"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#no-sniff","aria-hidden":"true"}},[t._v("#")]),t._v(" No Sniff")]),t._v(" "),s("p",[t._v("大多数现代浏览器试图通过嗅探其内容来检测请求的 Content-Type ，这意味着如果包含 JavaScript 代码，则以 .txt 结尾的文件可以作为 JavaScript 执行。")]),t._v(" "),s("p",[t._v("要禁用此行为，请设置 nosniff 为 false ：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  nosniff"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h4",{attrs:{id:"no-open"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#no-open","aria-hidden":"true"}},[t._v("#")]),t._v(" No Open")]),t._v(" "),s("p",[t._v("IE 用户可以在你的网站环境中执行网页，这是一个严重的安全风险。")]),t._v(" "),s("p",[t._v("要阻止 IE 在你的网站上下文中执行未知脚本，请确保 noopen 设置为 true (设置标题 X-Download-Options: noopen )：")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  noopen"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h4",{attrs:{id:"xframe"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#xframe","aria-hidden":"true"}},[t._v("#")]),t._v(" XFrame")]),t._v(" "),s("p",[t._v("文件中的 xframe 选项 config/shield.js 使你可以轻松控制网站在 iframe 中的嵌入行为。")]),t._v(" "),s("p",[t._v("可用选项是 DENY，SAMEORIGIN 或：ALLOW-FROM http://example.com")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  xframe"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'DENY'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])])},[],!1,null,null,null);a.default=e.exports}}]);