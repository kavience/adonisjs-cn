<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>查询构造器 | AdonisJs</title>
    <meta name="description" content="优雅的 Node.js web 框架">
    
    
    <link rel="preload" href="/adonisjs-cn/assets/css/0.styles.07756e39.css" as="style"><link rel="preload" href="/adonisjs-cn/assets/js/app.c41742cd.js" as="script"><link rel="preload" href="/adonisjs-cn/assets/js/2.b1db5fd3.js" as="script"><link rel="preload" href="/adonisjs-cn/assets/js/26.e31719b9.js" as="script"><link rel="prefetch" href="/adonisjs-cn/assets/js/10.1ed38306.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/11.2ba24294.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/12.d4817e8b.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/13.e96a7091.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/14.e1295915.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/15.4bf8099d.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/16.521ed7e6.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/17.3bcb33e1.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/18.ab54521b.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/19.f103b066.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/20.30ac3b4e.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/21.e8d4fbf0.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/22.6e24fd7a.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/23.8815a834.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/24.69934c30.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/25.3fa2bb64.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/27.c28e8720.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/28.78c6f3a1.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/29.c92ae8e7.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/3.a44ce1dc.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/30.9173a22a.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/31.8b1e08b5.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/32.c9bebadf.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/33.be983ab0.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/34.2e89255e.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/35.c239e37e.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/36.2b1f61a2.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/37.e4d75aad.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/38.46fd820c.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/39.f6212003.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/4.2b558e94.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/40.4fa920ef.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/41.4c80303a.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/42.921b4d8d.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/43.c3ed0f4b.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/44.403405dd.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/45.271974c0.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/46.ecd424a7.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/47.42f04805.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/48.dc2e267a.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/49.26cdf688.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/5.aafb1e29.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/50.3554bab0.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/51.43f09c88.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/52.47cfcab7.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/53.00a79228.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/54.b49c2b5c.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/55.d1d80aaf.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/56.ed0ebcd5.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/57.86f91034.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/58.729e2925.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/59.1bcb2cc7.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/6.c3cc58ad.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/60.20f13b4e.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/61.35271767.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/62.0d83dda5.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/63.2622ecdd.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/64.f98b218c.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/65.557e2843.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/66.2052b6e7.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/67.3067371e.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/68.8ece6c0a.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/69.49b464cb.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/7.297610bf.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/70.228d7edb.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/8.bc62987d.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/9.817f0e90.js">
    <link rel="stylesheet" href="/adonisjs-cn/assets/css/0.styles.07756e39.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/adonisjs-cn/" class="home-link router-link-active"><!----> <span class="site-name">AdonisJs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/adonisjs-cn/" class="nav-link">首页</a></div><div class="nav-item"><a href="/adonisjs-cn/start/" class="nav-link">快速开始</a></div><div class="nav-item"><a href="/adonisjs-cn/guides/preface/about.html" class="nav-link">指南</a></div><div class="nav-item"><a href="/adonisjs-cn/recipes/recipes/nginx-proxy.html" class="nav-link">专题</a></div><div class="nav-item"><a href="https://adonisjs.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  官网
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/adonisjs-cn/" class="nav-link">首页</a></div><div class="nav-item"><a href="/adonisjs-cn/start/" class="nav-link">快速开始</a></div><div class="nav-item"><a href="/adonisjs-cn/guides/preface/about.html" class="nav-link">指南</a></div><div class="nav-item"><a href="/adonisjs-cn/recipes/recipes/nginx-proxy.html" class="nav-link">专题</a></div><div class="nav-item"><a href="https://adonisjs.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  官网
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>序言</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/preface/why.html" class="sidebar-link">为什么要翻译 AdonisJs？</a></li><li><a href="/adonisjs-cn/guides/preface/about.html" class="sidebar-link">关于 AdonisJs</a></li><li><a href="/adonisjs-cn/guides/preface/upgrade.html" class="sidebar-link">从4.0版本升级到4.1版本</a></li><li><a href="/adonisjs-cn/guides/preface/contribution.html" class="sidebar-link">贡献指南</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>主要概念</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/concept/request-lifecycle.html" class="sidebar-link">Request 生命周期</a></li><li><a href="/adonisjs-cn/guides/concept/ioc-container.html" class="sidebar-link">IoC 容器</a></li><li><a href="/adonisjs-cn/guides/concept/service-provider.html" class="sidebar-link">服务提供者</a></li><li><a href="/adonisjs-cn/guides/concept/ignitor.html" class="sidebar-link">启动装置</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>快速开始</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/started/installation.html" class="sidebar-link">安装</a></li><li><a href="/adonisjs-cn/guides/started/configuration.html" class="sidebar-link">配置</a></li><li><a href="/adonisjs-cn/guides/started/directory-structure.html" class="sidebar-link">目录结构</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>基础入门</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/basics/routing.html" class="sidebar-link">路由</a></li><li><a href="/adonisjs-cn/guides/basics/middleware.html" class="sidebar-link">中间件</a></li><li><a href="/adonisjs-cn/guides/basics/controller.html" class="sidebar-link">控制器</a></li><li><a href="/adonisjs-cn/guides/basics/request.html" class="sidebar-link">请求</a></li><li><a href="/adonisjs-cn/guides/basics/response.html" class="sidebar-link">响应</a></li><li><a href="/adonisjs-cn/guides/basics/view.html" class="sidebar-link">视图</a></li><li><a href="/adonisjs-cn/guides/basics/session.html" class="sidebar-link">Session</a></li><li><a href="/adonisjs-cn/guides/basics/validator.html" class="sidebar-link">验证器</a></li><li><a href="/adonisjs-cn/guides/basics/error-handling.html" class="sidebar-link">异常处理</a></li><li><a href="/adonisjs-cn/guides/basics/logger.html" class="sidebar-link">logger 调试</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>安全</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/security/introduction.html" class="sidebar-link">介绍</a></li><li><a href="/adonisjs-cn/guides/security/authentication.html" class="sidebar-link">权限认证</a></li><li><a href="/adonisjs-cn/guides/security/cors.html" class="sidebar-link">CORS</a></li><li><a href="/adonisjs-cn/guides/security/csrf-protection.html" class="sidebar-link">CSRF</a></li><li><a href="/adonisjs-cn/guides/security/encryption.html" class="sidebar-link">加密</a></li><li><a href="/adonisjs-cn/guides/security/shield-middleware.html" class="sidebar-link">屏蔽中间件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>深入了解</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/deeper/ace-commands.html" class="sidebar-link">命令行工具</a></li><li><a href="/adonisjs-cn/guides/deeper/event.html" class="sidebar-link">事件</a></li><li><a href="/adonisjs-cn/guides/deeper/extend-core.html" class="sidebar-link">扩展内核</a></li><li><a href="/adonisjs-cn/guides/deeper/file-upload.html" class="sidebar-link">文件上传</a></li><li><a href="/adonisjs-cn/guides/deeper/file-storage.html" class="sidebar-link">文件存储</a></li><li><a href="/adonisjs-cn/guides/deeper/helper.html" class="sidebar-link">帮助</a></li><li><a href="/adonisjs-cn/guides/deeper/international.html" class="sidebar-link">国际化</a></li><li><a href="/adonisjs-cn/guides/deeper/mail.html" class="sidebar-link">邮箱</a></li><li><a href="/adonisjs-cn/guides/deeper/social-authentication.html" class="sidebar-link">公共认证</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/database/start.html" class="sidebar-link">快速开始</a></li><li><a href="/adonisjs-cn/guides/database/query-builder.html" class="active sidebar-link">查询构造器</a></li><li><a href="/adonisjs-cn/guides/database/migration.html" class="sidebar-link">数据库迁移</a></li><li><a href="/adonisjs-cn/guides/database/seeds-factory.html" class="sidebar-link">假数据填充</a></li><li><a href="/adonisjs-cn/guides/database/redis.html" class="sidebar-link">Redis缓存</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Lucid模型</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/orm/start.html" class="sidebar-link">快速开始</a></li><li><a href="/adonisjs-cn/guides/orm/hooks.html" class="sidebar-link">Hooks 函数</a></li><li><a href="/adonisjs-cn/guides/orm/traits.html" class="sidebar-link">Traits</a></li><li><a href="/adonisjs-cn/guides/orm/mutator.html" class="sidebar-link">修改器</a></li><li><a href="/adonisjs-cn/guides/orm/relationships-one.html" class="sidebar-link">关联(一)</a></li><li><a href="/adonisjs-cn/guides/orm/relationships-two.html" class="sidebar-link">关联(二)</a></li><li><a href="/adonisjs-cn/guides/orm/serialization.html" class="sidebar-link">序列化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>websocket</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/websockets/start.html" class="sidebar-link">快速开始</a></li><li><a href="/adonisjs-cn/guides/websockets/philosophy.html" class="sidebar-link">思想</a></li><li><a href="/adonisjs-cn/guides/websockets/server-api.html" class="sidebar-link">服务端接口</a></li><li><a href="/adonisjs-cn/guides/websockets/client-api.html" class="sidebar-link">客户端接口</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>测试</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/testing/start.html" class="sidebar-link">快速开始</a></li><li><a href="/adonisjs-cn/guides/testing/http-test.html" class="sidebar-link">HTTP 测试</a></li><li><a href="/adonisjs-cn/guides/testing/browser-test.html" class="sidebar-link">浏览器测试</a></li><li><a href="/adonisjs-cn/guides/testing/fakes.html" class="sidebar-link">Fake</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>结语</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/finally/about.html" class="sidebar-link">写在最后</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="查询构造器"><a href="#查询构造器" aria-hidden="true" class="header-anchor">#</a> 查询构造器</h1> <p>AdonisJs Query Builder 提供了使用 JavaScript 方法与 SQL 数据库交互的统一语法。</p> <p>本指南是对查询生成器上所有可用方法的引用。</p> <p>有关支持的数据库列表，配置选项以及如何调试 SQL 查询，请参阅数据库<a href="https://adonisjs.com/docs/4.1/database" target="_blank" rel="noopener noreferrer">入门指南<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h2 id="介绍"><a href="#介绍" aria-hidden="true" class="header-anchor">#</a> 介绍</h2> <p>即使你熟练使用 SQL ，编写 SQL 查询也很繁琐。</p> <h3 id="语法抽象"><a href="#语法抽象" aria-hidden="true" class="header-anchor">#</a> 语法抽象</h3> <p>想象一下，所有的查询都是为 MySQL 编写的，稍后你会被要求将所有内容迁移到 PostgreSQL 。你必须重写/修改你的 MySQL 查询，以确保它们仍然适用于 PostgreSQL 。</p> <p>查询生成器抽象出连接特定语法，因此你可以专注于应用程序功能而不是 SQL 语言的变体。</p> <h3 id="条件查询"><a href="#条件查询" aria-hidden="true" class="header-anchor">#</a> 条件查询</h3> <p>另一个问题可能是使用条件块构建增量查询：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 不使用 query builder</span>
<span class="token keyword">const</span> sql <span class="token operator">=</span> <span class="token string">'SELECT * FROM `users`'</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  sql <span class="token operator">+=</span> <span class="token string">' WHERE `username` = '</span> <span class="token operator">+</span> username
<span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code>、、 使用 query builder
<span class="token keyword">const</span> query <span class="token operator">=</span> Database<span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  query<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="基本例子"><a href="#基本例子" aria-hidden="true" class="header-anchor">#</a> 基本例子</h2> <p>这是使用查询生成器链接不同方法的基本示例：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> Database <span class="token operator">=</span> <span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'Database'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>

  <span class="token keyword">async</span> <span class="token function">index</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> Database
      <span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'john'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="选择"><a href="#选择" aria-hidden="true" class="header-anchor">#</a> 选择</h2> <p>该 select 方法定义了为给定查询选择的字段：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
<span class="token comment">// or</span>
<span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment"># SQL 输出</span>
<span class="token keyword">select</span> <span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>username<span class="token punctuation">`</span> <span class="token keyword">from</span> <span class="token punctuation">`</span>users<span class="token punctuation">`</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">`</span>users<span class="token punctuation">`</span>
</code></pre></div><p>你可以像这样定义查询别名：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'username as uname'</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="where-语句"><a href="#where-语句" aria-hidden="true" class="header-anchor">#</a> where 语句</h2> <p>Query Builder 提供了许多动态方法来添加 where 子句。</p> <p>它还通过传递闭包或其他查询而不是实际值来支持子查询。</p> <p>有关详细 where 信息，请参阅 Knex 的<a href="http://knexjs.org/#Builder-wheres" target="_blank" rel="noopener noreferrer">文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>传递 undefined 给 where 子句会在 SQL 编译期间导致错误，因此 undefined 在传递动态值之前不要确保它们。</p> <h4 id="where"><a href="#where" aria-hidden="true" class="header-anchor">#</a> where</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">// Or</span>
<span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>你可以将比较运算符传递给where子句，如下所示：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> adults <span class="token operator">=</span> <span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="where-with-callback"><a href="#where-with-callback" aria-hidden="true" class="header-anchor">#</a> where (with callback)</h4> <p>你可以将回调传递给该 where 子句，以便对回调中包含的所有子句进行分组：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">orWhere</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment"># SQL输出</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token punctuation">`</span>users<span class="token punctuation">`</span> <span class="token keyword">where</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">or</span> <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="wherenot"><a href="#wherenot" aria-hidden="true" class="header-anchor">#</a> whereNot</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">whereNot</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span>

<span class="token comment">// or</span>
<span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">whereNot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>username<span class="token punctuation">:</span> <span class="token string">'foo'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="wherein"><a href="#wherein" aria-hidden="true" class="header-anchor">#</a> whereIn</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">whereIn</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="wherenotin"><a href="#wherenotin" aria-hidden="true" class="header-anchor">#</a> whereNotIn</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">whereNotIn</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="wherenull"><a href="#wherenull" aria-hidden="true" class="header-anchor">#</a> whereNull</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">whereNull</span><span class="token punctuation">(</span><span class="token string">'deleted_at'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="wherenotnull"><a href="#wherenotnull" aria-hidden="true" class="header-anchor">#</a> whereNotNull</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">whereNotNull</span><span class="token punctuation">(</span><span class="token string">'created_at'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="whereexists"><a href="#whereexists" aria-hidden="true" class="header-anchor">#</a> whereExists</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whereExists</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'accounts'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'users.id'</span><span class="token punctuation">,</span> <span class="token string">'accounts.user_id'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="wherenotexists"><a href="#wherenotexists" aria-hidden="true" class="header-anchor">#</a> whereNotExists</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whereNotExists</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'accounts'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'users.id'</span><span class="token punctuation">,</span> <span class="token string">'accounts.user_id'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="wherebetween"><a href="#wherebetween" aria-hidden="true" class="header-anchor">#</a> whereBetween</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">whereBetween</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="wherenotbetween"><a href="#wherenotbetween" aria-hidden="true" class="header-anchor">#</a> whereNotBetween</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">whereNotBetween</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="whereraw"><a href="#whereraw" aria-hidden="true" class="header-anchor">#</a> whereRaw</h4> <p>便利助手 .where(Database.raw(query))：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">whereRaw</span><span class="token punctuation">(</span><span class="token string">'id = ?'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="joins"><a href="#joins" aria-hidden="true" class="header-anchor">#</a> Joins</h2> <h4 id="innerjoin"><a href="#innerjoin" aria-hidden="true" class="header-anchor">#</a> innerJoin</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">innerJoin</span><span class="token punctuation">(</span><span class="token string">'accounts'</span><span class="token punctuation">,</span> <span class="token string">'user.id'</span><span class="token punctuation">,</span> <span class="token string">'accounts.user_id'</span><span class="token punctuation">)</span>
</code></pre></div><p>你还可以传递回调以构建连接：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">innerJoin</span><span class="token punctuation">(</span><span class="token string">'accounts'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span>
      <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'users.id'</span><span class="token punctuation">,</span> <span class="token string">'accounts.user_id'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">orOn</span><span class="token punctuation">(</span><span class="token string">'users.id'</span><span class="token punctuation">,</span> <span class="token string">'accounts.owner_id'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="leftjoin"><a href="#leftjoin" aria-hidden="true" class="header-anchor">#</a> leftJoin</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Database
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">leftJoin</span><span class="token punctuation">(</span><span class="token string">'accounts'</span><span class="token punctuation">,</span> <span class="token string">'users.id'</span><span class="token punctuation">,</span> <span class="token string">'accounts.user_id'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="leftouterjoin"><a href="#leftouterjoin" aria-hidden="true" class="header-anchor">#</a> leftOuterJoin</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">leftOuterJoin</span><span class="token punctuation">(</span><span class="token string">'accounts'</span><span class="token punctuation">,</span> <span class="token string">'users.id'</span><span class="token punctuation">,</span> <span class="token string">'accounts.user_id'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="rightjoin"><a href="#rightjoin" aria-hidden="true" class="header-anchor">#</a> rightJoin</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">rightJoin</span><span class="token punctuation">(</span><span class="token string">'accounts'</span><span class="token punctuation">,</span> <span class="token string">'users.id'</span><span class="token punctuation">,</span> <span class="token string">'accounts.user_id'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="rightouterjoin"><a href="#rightouterjoin" aria-hidden="true" class="header-anchor">#</a> rightOuterJoin</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">rightOuterJoin</span><span class="token punctuation">(</span><span class="token string">'accounts'</span><span class="token punctuation">,</span> <span class="token string">'users.id'</span><span class="token punctuation">,</span> <span class="token string">'accounts.user_id'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="outerjoin"><a href="#outerjoin" aria-hidden="true" class="header-anchor">#</a> outerJoin</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">outerJoin</span><span class="token punctuation">(</span><span class="token string">'accounts'</span><span class="token punctuation">,</span> <span class="token string">'users.id'</span><span class="token punctuation">,</span> <span class="token string">'accounts.user_id'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="fullouterjoin"><a href="#fullouterjoin" aria-hidden="true" class="header-anchor">#</a> fullOuterJoin</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">fullOuterJoin</span><span class="token punctuation">(</span><span class="token string">'accounts'</span><span class="token punctuation">,</span> <span class="token string">'users.id'</span><span class="token punctuation">,</span> <span class="token string">'accounts.user_id'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="crossjoin"><a href="#crossjoin" aria-hidden="true" class="header-anchor">#</a> crossJoin</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">crossJoin</span><span class="token punctuation">(</span><span class="token string">'accounts'</span><span class="token punctuation">,</span> <span class="token string">'users.id'</span><span class="token punctuation">,</span> <span class="token string">'accounts.user_id'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="joinraw"><a href="#joinraw" aria-hidden="true" class="header-anchor">#</a> joinRaw</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'accounts'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">joinRaw</span><span class="token punctuation">(</span><span class="token string">'natural full join table1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="ordering-and-limits"><a href="#ordering-and-limits" aria-hidden="true" class="header-anchor">#</a> Ordering and Limits</h2> <h4 id="distinct"><a href="#distinct" aria-hidden="true" class="header-anchor">#</a> distinct</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">distinct</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="通过-分组"><a href="#通过-分组" aria-hidden="true" class="header-anchor">#</a> 通过...分组</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="groupbyraw"><a href="#groupbyraw" aria-hidden="true" class="header-anchor">#</a> groupByRaw</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">groupByRaw</span><span class="token punctuation">(</span><span class="token string">'age, status'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="orderby-column，-direction-asc"><a href="#orderby-column，-direction-asc" aria-hidden="true" class="header-anchor">#</a> orderBy(column，[direction = asc])</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'desc'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="orderbyraw-column，-direction-asc"><a href="#orderbyraw-column，-direction-asc" aria-hidden="true" class="header-anchor">#</a> orderByRaw(column，[direction = asc])</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orderByRaw</span><span class="token punctuation">(</span><span class="token string">'col NULLS LAST DESC'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="having"><a href="#having" aria-hidden="true" class="header-anchor">#</a> having</h4> <blockquote><p>groupBy() 必须先调用 having() 。</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">having</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="offset-limit-value"><a href="#offset-limit-value" aria-hidden="true" class="header-anchor">#</a> offset/limit(value)</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="inserts"><a href="#inserts" aria-hidden="true" class="header-anchor">#</a> Inserts</h2> <h4 id="insert-values"><a href="#insert-values" aria-hidden="true" class="header-anchor">#</a> insert(values)</h4> <p>insert 操作创建一行并返回其新创建的 id ：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> userId <span class="token operator">=</span> <span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>username<span class="token punctuation">:</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>在批量插入的情况下，id 返回第一个记录(这是 MySQL 本身的限制；请参阅 <a href="http://dev.mysql.com/doc/refman/5.6/en/information-functions.html#function_last-insert-id" target="_blank" rel="noopener noreferrer">LAST_INSERT_ID<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> )：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// BULK INSERT</span>
<span class="token keyword">const</span> firstUserId <span class="token operator">=</span> <span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>username<span class="token punctuation">:</span> <span class="token string">'foo'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>username<span class="token punctuation">:</span> <span class="token string">'bar'</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="into-tablename"><a href="#into-tablename" aria-hidden="true" class="header-anchor">#</a> into(tableName)</h4> <p>into 方法比 table/from 插入数据库行时使用的方法更具可读性：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> userId <span class="token operator">=</span> <span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>username<span class="token punctuation">:</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="postgresql-return-column"><a href="#postgresql-return-column" aria-hidden="true" class="header-anchor">#</a> PostgreSQL Return Column</h3> <p>对于 PostgreSQL ，你必须显式定义返回列(所有其他数据库客户端忽略此语句)：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> userId <span class="token operator">=</span> <span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span> username<span class="token punctuation">:</span> <span class="token string">'virk'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">returning</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="更新"><a href="#更新" aria-hidden="true" class="header-anchor">#</a> 更新</h2> <p>所有更新操作都返回受影响的行数：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> affectedRows <span class="token operator">=</span> <span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'tutlage'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token string">'lastname'</span><span class="token punctuation">,</span> <span class="token string">'Virk'</span><span class="token punctuation">)</span>
</code></pre></div><p>要更新多个列，请将这些列/值作为对象传递：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> affectedRows <span class="token operator">=</span> <span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'tutlage'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> lastname<span class="token punctuation">:</span> <span class="token string">'Virk'</span><span class="token punctuation">,</span> firstname<span class="token punctuation">:</span> <span class="token string">'Aman'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="删除"><a href="#删除" aria-hidden="true" class="header-anchor">#</a> 删除</h2> <h4 id="delete"><a href="#delete" aria-hidden="true" class="header-anchor">#</a> delete</h4> <p>删除操作还会返回受影响的行数：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> affectedRows <span class="token operator">=</span> <span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'tutlage'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>作为 delete 被保留在 JavaScript 中保留的关键字，你也可以使用替代 del() 方法。
截短
Truncate 删除所有表行，将表自动增量 id 重置为 0 ：</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">truncate</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="分页"><a href="#分页" aria-hidden="true" class="header-anchor">#</a> 分页</h2> <p>查询生成器提供了方便的方法来分页数据库结果。</p> <h4 id="forpage-page-limit-20"><a href="#forpage-page-limit-20" aria-hidden="true" class="header-anchor">#</a> forPage(page, [limit = 20])</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">forPage</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="paginate-page-limit-20"><a href="#paginate-page-limit-20" aria-hidden="true" class="header-anchor">#</a> paginate(page, [limit = 20])</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">paginate</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>paginate 方法的输出与 forPage 方法不同。</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 输出</span>
<span class="token punctuation">{</span>
  total<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  perPage<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  lastPage<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  page<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  data<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果使用 PostgreSQL ，则 total 密钥将是一个字符串，因为 JavaScript 无法 bigint 本机处理(有关推荐的解决方案，请参阅<a href="https://github.com/adonisjs/adonis-lucid/issues/339#issuecomment-387399508" target="_blank" rel="noopener noreferrer">此问题<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)。</p> <h2 id="数据库事务"><a href="#数据库事务" aria-hidden="true" class="header-anchor">#</a> 数据库事务</h2> <p>数据库事务是安全操作，在你明确提交更改之前，这些操作不会反映在数据库中。</p> <h4 id="begintransaction"><a href="#begintransaction" aria-hidden="true" class="header-anchor">#</a> beginTransaction</h4> <p>beginTransaction 方法返回事务对象，可用于执行任何查询：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> trx <span class="token operator">=</span> <span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">await</span> trx<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>username<span class="token punctuation">:</span> <span class="token string">'virk'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>

<span class="token keyword">await</span> trx<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// insert query will take place on commit</span>
<span class="token keyword">await</span> trx<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// will not insert anything</span>
</code></pre></div><h4 id="transaction"><a href="#transaction" aria-hidden="true" class="header-anchor">#</a> transaction</h4> <p>你还可以将事务包装在回调中：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">trx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> trx<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>username<span class="token punctuation">:</span> <span class="token string">'virk'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>你无需在此回调中调用 commit 或 rollback 手动调用。
如果你的任何查询引发错误，则事务将自动回滚，否则将提交。</p></blockquote> <h2 id="aggregates"><a href="#aggregates" aria-hidden="true" class="header-anchor">#</a> Aggregates</h2> <p>Query Builder 公开了 Knex 的<a href="http://knexjs.org/#Builder-count" target="_blank" rel="noopener noreferrer">聚合函数<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的全部功能。</p> <h4 id="计数"><a href="#计数" aria-hidden="true" class="header-anchor">#</a> 计数()</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token comment">// returns array</span>

<span class="token keyword">const</span> total <span class="token operator">=</span> count<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'count(*)'</span><span class="token punctuation">]</span>    <span class="token comment">// returns number</span>

<span class="token comment">// COUNT A COLUMN</span>
<span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span>                 <span class="token comment">// returns array</span>

<span class="token keyword">const</span> total <span class="token operator">=</span> count<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'count(&quot;id&quot;)'</span><span class="token punctuation">]</span>    <span class="token comment">// returns number</span>

<span class="token comment">// COUNT COLUMN AS NAME</span>
<span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token string">'* as total'</span><span class="token punctuation">)</span>            <span class="token comment">// returns array</span>

<span class="token keyword">const</span> total <span class="token operator">=</span> count<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>total       <span class="token comment">// returns number</span>
</code></pre></div><h4 id="countdistinct"><a href="#countdistinct" aria-hidden="true" class="header-anchor">#</a> countDistinct</h4> <p>countDistinct 是一样的 count ，但添加了一个 distinct 表达式：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">countDistinct</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span>                          <span class="token comment">// returns array</span>

<span class="token keyword">const</span> total <span class="token operator">=</span> count<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'count(distinct &quot;id&quot;)'</span><span class="token punctuation">]</span>  <span class="token comment">// returns number</span>
</code></pre></div><h4 id="min"><a href="#min" aria-hidden="true" class="header-anchor">#</a> min</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>         <span class="token comment">// returns array</span>
<span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token string">'age as a'</span><span class="token punctuation">)</span>    <span class="token comment">// returns array</span>
</code></pre></div><h4 id="max"><a href="#max" aria-hidden="true" class="header-anchor">#</a> max</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>         <span class="token comment">// returns array</span>
<span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token string">'age as a'</span><span class="token punctuation">)</span>    <span class="token comment">// returns array</span>
</code></pre></div><h4 id="sum"><a href="#sum" aria-hidden="true" class="header-anchor">#</a> sum</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'cart'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">'total'</span><span class="token punctuation">)</span>        <span class="token comment">// returns array</span>
<span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'cart'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token string">'total as t'</span><span class="token punctuation">)</span>   <span class="token comment">// returns array</span>
sumDistinct
<span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'cart'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sumDistinct</span><span class="token punctuation">(</span><span class="token string">'total'</span><span class="token punctuation">)</span>      <span class="token comment">// returns array</span>
<span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'cart'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sumDistinct</span><span class="token punctuation">(</span><span class="token string">'total as t'</span><span class="token punctuation">)</span> <span class="token comment">// returns array</span>
</code></pre></div><h4 id="sumdistinct"><a href="#sumdistinct" aria-hidden="true" class="header-anchor">#</a> sumDistinct</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>         <span class="token comment">// returns array</span>
<span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">'age as age'</span><span class="token punctuation">)</span>  <span class="token comment">// returns array</span>
</code></pre></div><h4 id="avgdistinct"><a href="#avgdistinct" aria-hidden="true" class="header-anchor">#</a> avgDistinct</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">avgDistinct</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>         <span class="token comment">// returns array</span>
<span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">avgDistinct</span><span class="token punctuation">(</span><span class="token string">'age as age'</span><span class="token punctuation">)</span>  <span class="token comment">// returns array</span>
</code></pre></div><h4 id="自增"><a href="#自增" aria-hidden="true" class="header-anchor">#</a> 自增</h4> <p>通过以下方式增加列值：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'credits'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token string">'balance'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="自减"><a href="#自减" aria-hidden="true" class="header-anchor">#</a> 自减</h4> <p>通过以下方式减少列值：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'credits'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">decrement</span><span class="token punctuation">(</span><span class="token string">'balance'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="聚合助手"><a href="#聚合助手" aria-hidden="true" class="header-anchor">#</a> 聚合助手</h3> <p>AdonisJs 查询生成器还使用有用的常用聚合查询快捷方法扩展了 Knex 的查询聚合。这些辅助方法结束查询构建器链并返回一个值。</p> <p>所有帮助程序都接受用于聚合的列名。如果可能，Query Builder 将为列名选择默认值。</p> <p>例如 sum() 一样的方法，需要列名。</p> <p>底层 Knex 查询制造商确定的方法：count()，countDistinct()，avg()，avgDistinct()，sum()，sumDistinct()，min()，和 max() 。为了避免混淆和命名冲突，Query Builder 将其聚合辅助方法作为前缀 get(例如getCount) 。</p> <h4 id="getcount-columnname"><a href="#getcount-columnname" aria-hidden="true" class="header-anchor">#</a> getCount(columnName ='*')</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> total <span class="token operator">=</span> <span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                   <span class="token comment">// returns number</span>
</code></pre></div><h4 id="getcountdistinct-columnname"><a href="#getcountdistinct-columnname" aria-hidden="true" class="header-anchor">#</a> getCountDistinct(COLUMNNAME)</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> total <span class="token operator">=</span> <span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">countDistinct</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span>                          <span class="token comment">// returns number</span>
</code></pre></div><h4 id="getmin-columnname"><a href="#getmin-columnname" aria-hidden="true" class="header-anchor">#</a> getMin(COLUMNNAME)</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMin</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>      <span class="token comment">// returns a number</span>
</code></pre></div><h4 id="getmax的-columnname"><a href="#getmax的-columnname" aria-hidden="true" class="header-anchor">#</a> getMax的(COLUMNNAME)</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMax</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>      <span class="token comment">// returns number</span>
</code></pre></div><h4 id="getsum-columnname"><a href="#getsum-columnname" aria-hidden="true" class="header-anchor">#</a> getSum(COLUMNNAME)</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'cart'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSum</span><span class="token punctuation">(</span><span class="token string">'total'</span><span class="token punctuation">)</span>     <span class="token comment">// returns number</span>
</code></pre></div><h4 id="getsumdistinct-columnname"><a href="#getsumdistinct-columnname" aria-hidden="true" class="header-anchor">#</a> getSumDistinct(COLUMNNAME)</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'cart'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSumDistinct</span><span class="token punctuation">(</span><span class="token string">'total'</span><span class="token punctuation">)</span>   <span class="token comment">// returns number</span>
</code></pre></div><h4 id="getavg-columnname"><a href="#getavg-columnname" aria-hidden="true" class="header-anchor">#</a> getAvg(COLUMNNAME)</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAvg</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>      <span class="token comment">// returns number</span>
</code></pre></div><h4 id="getavgdistinct-columnname"><a href="#getavgdistinct-columnname" aria-hidden="true" class="header-anchor">#</a> getAvgDistinct(COLUMNNAME)</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAvgDistinct</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>      <span class="token comment">// returns number</span>
</code></pre></div><h2 id="帮助函数"><a href="#帮助函数" aria-hidden="true" class="header-anchor">#</a> 帮助函数</h2> <h4 id="pluck-column"><a href="#pluck-column" aria-hidden="true" class="header-anchor">#</a> pluck(column)</h4> <p>pluck 方法将返回所选列的值数组：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> usersIds <span class="token operator">=</span> <span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pluck</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="first"><a href="#first" aria-hidden="true" class="header-anchor">#</a> first</h4> <p>first 方法查询满足条件的第一条数据：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="clone"><a href="#clone" aria-hidden="true" class="header-anchor">#</a> clone</h4> <p>clone 当前查询链以供以后使用：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> query <span class="token operator">=</span> Database
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">,</span> <span class="token string">'virk'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// later</span>
<span class="token keyword">await</span> query
</code></pre></div><h4 id="columninfo"><a href="#columninfo" aria-hidden="true" class="header-anchor">#</a> columnInfo</h4> <p>返回给定列的信息：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> username <span class="token operator">=</span> <span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">table</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">columnInfo</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="子查询"><a href="#子查询" aria-hidden="true" class="header-anchor">#</a> 子查询</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> subquery <span class="token operator">=</span> Database
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'accounts'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'account_name'</span><span class="token punctuation">,</span> <span class="token string">'somename'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'account_name'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">whereIn</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> subquery<span class="token punctuation">)</span>
select <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token template-string"><span class="token string">`users`</span></span> where <span class="token template-string"><span class="token string">`id`</span></span> <span class="token keyword">in</span> <span class="token punctuation">(</span>select <span class="token template-string"><span class="token string">`account_name`</span></span> <span class="token keyword">from</span> <span class="token template-string"><span class="token string">`accounts`</span></span> where <span class="token template-string"><span class="token string">`account_name`</span></span> <span class="token operator">=</span> <span class="token string">'somename'</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="原始查询"><a href="#原始查询" aria-hidden="true" class="header-anchor">#</a> 原始查询</h2> <p>Database.raw 方法应该用于运行原始 SQL 查询：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> Database
  <span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string">'select * from users where username = ?'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>username<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="关闭连接"><a href="#关闭连接" aria-hidden="true" class="header-anchor">#</a> 关闭连接</h2> <p>可以通过调用 close 方法来关闭数据库连接。默认情况下，此方法关闭所有打开的数据库连接。</p> <p>要关闭所选连接，请传递一组连接名称：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Database<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// all</span>

Database<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'sqlite'</span><span class="token punctuation">,</span> <span class="token string">'mysql'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后一次更新: </span> <span class="time">7/1/2019, 11:11:51 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/adonisjs-cn/guides/database/start.html" class="prev">
          快速开始
        </a></span> <span class="next"><a href="/adonisjs-cn/guides/database/migration.html">
          数据库迁移
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/adonisjs-cn/assets/js/app.c41742cd.js" defer></script><script src="/adonisjs-cn/assets/js/2.b1db5fd3.js" defer></script><script src="/adonisjs-cn/assets/js/26.e31719b9.js" defer></script>
  </body>
</html>
