<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>IoC 容器 | AdonisJs</title>
    <meta name="description" content="优雅的 Node.js web 框架">
    
    
    <link rel="preload" href="/adonisjs-cn/assets/css/0.styles.07756e39.css" as="style"><link rel="preload" href="/adonisjs-cn/assets/js/app.c41742cd.js" as="script"><link rel="preload" href="/adonisjs-cn/assets/js/2.b1db5fd3.js" as="script"><link rel="preload" href="/adonisjs-cn/assets/js/22.6e24fd7a.js" as="script"><link rel="prefetch" href="/adonisjs-cn/assets/js/10.1ed38306.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/11.2ba24294.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/12.d4817e8b.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/13.e96a7091.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/14.e1295915.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/15.4bf8099d.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/16.521ed7e6.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/17.3bcb33e1.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/18.ab54521b.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/19.f103b066.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/20.30ac3b4e.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/21.e8d4fbf0.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/23.8815a834.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/24.69934c30.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/25.3fa2bb64.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/26.e31719b9.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/27.c28e8720.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/28.78c6f3a1.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/29.c92ae8e7.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/3.a44ce1dc.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/30.9173a22a.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/31.8b1e08b5.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/32.c9bebadf.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/33.be983ab0.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/34.2e89255e.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/35.c239e37e.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/36.2b1f61a2.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/37.e4d75aad.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/38.46fd820c.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/39.f6212003.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/4.2b558e94.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/40.4fa920ef.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/41.4c80303a.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/42.921b4d8d.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/43.c3ed0f4b.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/44.403405dd.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/45.271974c0.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/46.ecd424a7.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/47.42f04805.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/48.dc2e267a.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/49.26cdf688.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/5.aafb1e29.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/50.3554bab0.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/51.43f09c88.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/52.47cfcab7.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/53.00a79228.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/54.b49c2b5c.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/55.d1d80aaf.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/56.ed0ebcd5.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/57.86f91034.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/58.729e2925.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/59.1bcb2cc7.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/6.c3cc58ad.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/60.20f13b4e.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/61.35271767.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/62.0d83dda5.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/63.2622ecdd.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/64.f98b218c.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/65.557e2843.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/66.2052b6e7.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/67.3067371e.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/68.8ece6c0a.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/69.49b464cb.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/7.297610bf.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/70.228d7edb.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/8.bc62987d.js"><link rel="prefetch" href="/adonisjs-cn/assets/js/9.817f0e90.js">
    <link rel="stylesheet" href="/adonisjs-cn/assets/css/0.styles.07756e39.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/adonisjs-cn/" class="home-link router-link-active"><!----> <span class="site-name">AdonisJs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/adonisjs-cn/" class="nav-link">首页</a></div><div class="nav-item"><a href="/adonisjs-cn/start/" class="nav-link">快速开始</a></div><div class="nav-item"><a href="/adonisjs-cn/guides/preface/about.html" class="nav-link">指南</a></div><div class="nav-item"><a href="/adonisjs-cn/recipes/recipes/nginx-proxy.html" class="nav-link">专题</a></div><div class="nav-item"><a href="https://adonisjs.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  官网
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/adonisjs-cn/" class="nav-link">首页</a></div><div class="nav-item"><a href="/adonisjs-cn/start/" class="nav-link">快速开始</a></div><div class="nav-item"><a href="/adonisjs-cn/guides/preface/about.html" class="nav-link">指南</a></div><div class="nav-item"><a href="/adonisjs-cn/recipes/recipes/nginx-proxy.html" class="nav-link">专题</a></div><div class="nav-item"><a href="https://adonisjs.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  官网
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>序言</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/preface/why.html" class="sidebar-link">为什么要翻译 AdonisJs？</a></li><li><a href="/adonisjs-cn/guides/preface/about.html" class="sidebar-link">关于 AdonisJs</a></li><li><a href="/adonisjs-cn/guides/preface/upgrade.html" class="sidebar-link">从4.0版本升级到4.1版本</a></li><li><a href="/adonisjs-cn/guides/preface/contribution.html" class="sidebar-link">贡献指南</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>主要概念</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/concept/request-lifecycle.html" class="sidebar-link">Request 生命周期</a></li><li><a href="/adonisjs-cn/guides/concept/ioc-container.html" class="active sidebar-link">IoC 容器</a></li><li><a href="/adonisjs-cn/guides/concept/service-provider.html" class="sidebar-link">服务提供者</a></li><li><a href="/adonisjs-cn/guides/concept/ignitor.html" class="sidebar-link">启动装置</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>快速开始</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/started/installation.html" class="sidebar-link">安装</a></li><li><a href="/adonisjs-cn/guides/started/configuration.html" class="sidebar-link">配置</a></li><li><a href="/adonisjs-cn/guides/started/directory-structure.html" class="sidebar-link">目录结构</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>基础入门</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/basics/routing.html" class="sidebar-link">路由</a></li><li><a href="/adonisjs-cn/guides/basics/middleware.html" class="sidebar-link">中间件</a></li><li><a href="/adonisjs-cn/guides/basics/controller.html" class="sidebar-link">控制器</a></li><li><a href="/adonisjs-cn/guides/basics/request.html" class="sidebar-link">请求</a></li><li><a href="/adonisjs-cn/guides/basics/response.html" class="sidebar-link">响应</a></li><li><a href="/adonisjs-cn/guides/basics/view.html" class="sidebar-link">视图</a></li><li><a href="/adonisjs-cn/guides/basics/session.html" class="sidebar-link">Session</a></li><li><a href="/adonisjs-cn/guides/basics/validator.html" class="sidebar-link">验证器</a></li><li><a href="/adonisjs-cn/guides/basics/error-handling.html" class="sidebar-link">异常处理</a></li><li><a href="/adonisjs-cn/guides/basics/logger.html" class="sidebar-link">logger 调试</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>安全</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/security/introduction.html" class="sidebar-link">介绍</a></li><li><a href="/adonisjs-cn/guides/security/authentication.html" class="sidebar-link">权限认证</a></li><li><a href="/adonisjs-cn/guides/security/cors.html" class="sidebar-link">CORS</a></li><li><a href="/adonisjs-cn/guides/security/csrf-protection.html" class="sidebar-link">CSRF</a></li><li><a href="/adonisjs-cn/guides/security/encryption.html" class="sidebar-link">加密</a></li><li><a href="/adonisjs-cn/guides/security/shield-middleware.html" class="sidebar-link">屏蔽中间件</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>深入了解</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/deeper/ace-commands.html" class="sidebar-link">命令行工具</a></li><li><a href="/adonisjs-cn/guides/deeper/event.html" class="sidebar-link">事件</a></li><li><a href="/adonisjs-cn/guides/deeper/extend-core.html" class="sidebar-link">扩展内核</a></li><li><a href="/adonisjs-cn/guides/deeper/file-upload.html" class="sidebar-link">文件上传</a></li><li><a href="/adonisjs-cn/guides/deeper/file-storage.html" class="sidebar-link">文件存储</a></li><li><a href="/adonisjs-cn/guides/deeper/helper.html" class="sidebar-link">帮助</a></li><li><a href="/adonisjs-cn/guides/deeper/international.html" class="sidebar-link">国际化</a></li><li><a href="/adonisjs-cn/guides/deeper/mail.html" class="sidebar-link">邮箱</a></li><li><a href="/adonisjs-cn/guides/deeper/social-authentication.html" class="sidebar-link">公共认证</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/database/start.html" class="sidebar-link">快速开始</a></li><li><a href="/adonisjs-cn/guides/database/query-builder.html" class="sidebar-link">查询构造器</a></li><li><a href="/adonisjs-cn/guides/database/migration.html" class="sidebar-link">数据库迁移</a></li><li><a href="/adonisjs-cn/guides/database/seeds-factory.html" class="sidebar-link">假数据填充</a></li><li><a href="/adonisjs-cn/guides/database/redis.html" class="sidebar-link">Redis缓存</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Lucid模型</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/orm/start.html" class="sidebar-link">快速开始</a></li><li><a href="/adonisjs-cn/guides/orm/hooks.html" class="sidebar-link">Hooks 函数</a></li><li><a href="/adonisjs-cn/guides/orm/traits.html" class="sidebar-link">Traits</a></li><li><a href="/adonisjs-cn/guides/orm/mutator.html" class="sidebar-link">修改器</a></li><li><a href="/adonisjs-cn/guides/orm/relationships-one.html" class="sidebar-link">关联(一)</a></li><li><a href="/adonisjs-cn/guides/orm/relationships-two.html" class="sidebar-link">关联(二)</a></li><li><a href="/adonisjs-cn/guides/orm/serialization.html" class="sidebar-link">序列化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>websocket</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/websockets/start.html" class="sidebar-link">快速开始</a></li><li><a href="/adonisjs-cn/guides/websockets/philosophy.html" class="sidebar-link">思想</a></li><li><a href="/adonisjs-cn/guides/websockets/server-api.html" class="sidebar-link">服务端接口</a></li><li><a href="/adonisjs-cn/guides/websockets/client-api.html" class="sidebar-link">客户端接口</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>测试</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/testing/start.html" class="sidebar-link">快速开始</a></li><li><a href="/adonisjs-cn/guides/testing/http-test.html" class="sidebar-link">HTTP 测试</a></li><li><a href="/adonisjs-cn/guides/testing/browser-test.html" class="sidebar-link">浏览器测试</a></li><li><a href="/adonisjs-cn/guides/testing/fakes.html" class="sidebar-link">Fake</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>结语</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/adonisjs-cn/guides/finally/about.html" class="sidebar-link">写在最后</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ioc-容器"><a href="#ioc-容器" aria-hidden="true" class="header-anchor">#</a> IoC 容器</h1> <h2 id="介绍"><a href="#介绍" aria-hidden="true" class="header-anchor">#</a> 介绍</h2> <p>在理解控制反转( IoC )容器的使用和好处之前，我们需要回过头来了解大型代码库所面临的依赖关系管理问题。</p> <h3 id="无用的抽象"><a href="#无用的抽象" aria-hidden="true" class="header-anchor">#</a> 无用的抽象</h3> <p>经常会遇到这样的情况，你必须为库创建无用的抽象来管理其生命周期。</p> <p>例如，为了确保数据库只连接一次，你可以将所有数据库设置代码移动到它自己的文件中(例如 lib/database.js )，然后在应用程序中导入:</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> knex <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'knex'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token function">knex</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  client<span class="token punctuation">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
  connection<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> connection

</code></pre></div><p>现在，不需要直接使用 knex ，你可以在任何需要的地方使用 lib/database.js 。</p> <p>这对于单个依赖项来说没有问题，但是随着应用程序的增长，你会发现代码库中有许多这样的文件在增长，这并不理想。</p> <h3 id="依赖关系管理"><a href="#依赖关系管理" aria-hidden="true" class="header-anchor">#</a> 依赖关系管理</h3> <p>大型代码库面临的最大问题之一是依赖关系的管理。</p> <p>由于依赖项彼此不了解，开发人员必须以某种方式将它们连接在一起。</p> <p>让我们以存储在 redis 数据库中的会话为例:</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Session</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">redis</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// needs Redis instance</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Redis</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// needs Config instance</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">configDirectory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// needs config directory path</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>可以看到，会话类依赖于 Redis 类， Redis 类依赖于配置类，等等。</p> <p>当使用会话类时，我们必须正确地构建它的依赖关系:</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span>configDirectory<span class="token punctuation">)</span>
<span class="token keyword">const</span> redis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Redis</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
<span class="token keyword">const</span> session <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Session</span><span class="token punctuation">(</span>redis<span class="token punctuation">)</span>

</code></pre></div><p>由于依赖项列表可能会根据项目的需求而增加，你可以很快想象这个顺序实例化过程将如何开始失控!</p> <p>这就是 IoC 容器发挥作用的地方，它负责为你解决依赖关系。</p> <h3 id="痛苦的测试"><a href="#痛苦的测试" aria-hidden="true" class="header-anchor">#</a> 痛苦的测试</h3> <p>当不使用 IoC 容器时，你必须想出不同的方法来模拟依赖关系，或者依赖于像 sinonjs 这样的库。</p> <p>使用 IoC 容器时，创建 fakes 很简单，因为所有依赖项都是从 IoC 容器解析的，而不是直接从文件系统解析的。</p> <h2 id="绑定依赖关系"><a href="#绑定依赖关系" aria-hidden="true" class="header-anchor">#</a> 绑定依赖关系</h2> <p>假设我们想要 Redis 在 IoC 容器中绑定库，确保它知道如何编写自己。</p> <blockquote><p>IoC 容器其实没什么，控制模块之间的依赖关系是一个相当简单的想法，但是开辟了一个全新的世界。
第一步是创建 Redis 类，并将所有依赖项定义为构造参数：</p></blockquote> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Redis</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span> <span class="token punctuation">(</span><span class="token parameter">Config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> redisConfig <span class="token operator">=</span> Config<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'redis'</span><span class="token punctuation">)</span>
    <span class="token comment">// connect to redis server</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Redis
</code></pre></div><p>请注意， Config 是构造函数依赖项，而不是 require 语句。</p> <p>接下来，让我们将 Redis 类绑定到 IoC 容器 My/Redis ：</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> ioc <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@adonisjs/fold'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Redis'</span><span class="token punctuation">)</span>

<span class="token function">ioc</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string">'My/Redis'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> Config <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'Adonis/Src/Config'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Redis</span><span class="token punctuation">(</span>Config<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>然后我们可以像这样使用 My/Redis 绑定：</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> redis <span class="token operator">=</span> ioc<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'My/Redis'</span><span class="token punctuation">)</span>
</code></pre></div><ol><li><p>该 ioc.bind 方法有两个参数：</p> <ul><li><p>绑定的名称(例如 My/Redis )</p></li> <li><p>每次访问绑定时都会执行一个工厂函数，返回绑定的最终值</p></li></ul></li> <li><p>由于我们使用的是 IoC 容器，因此我们会提取任何现有的绑定(例如 Config )并将其传递给 Redis 类。</p></li> <li><p>最后，我们返回一个新的实例Redis，已配置并可供使用。</p></li></ol> <h3 id="单例模式"><a href="#单例模式" aria-hidden="true" class="header-anchor">#</a> 单例模式</h3> <p>我们刚刚创建的绑定 <strong>My/Redis</strong> 存在一个这样的问题：</p> <p>每次我们从 IoC 容器中获取它时，它返回一个新 Redis 实例，然后都会创建一个新的 Redis 服务器连接。</p> <p>为了解决这个问题，IoC 容器允许你使用单例模式：</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>ioc<span class="token punctuation">.</span><span class="token function">singleton</span><span class="token punctuation">(</span><span class="token string">'My/Redis'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> Config <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'Adonis/Src/Config'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Redis</span><span class="token punctuation">(</span>Config<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>相比于 ioc.bind ，ioc.singleton 会缓存它的第一个返回值，当再次使用 My/Redis 的时候，仍将返回上一个 Redis 实例。</p> <h2 id="解决依赖关系"><a href="#解决依赖关系" aria-hidden="true" class="header-anchor">#</a> 解决依赖关系</h2> <p>只需调用 ioc.use 方法并为其指定命名空间即可：</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> redis <span class="token operator">=</span> ioc<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'My/Redis'</span><span class="token punctuation">)</span>
</code></pre></div><p>也可以使用 use 全局方法：</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> redis <span class="token operator">=</span> <span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'My/Redis'</span><span class="token punctuation">)</span>
</code></pre></div><p>从 IoC 容器解析依赖关系时执行的步骤是：</p> <ol><li><p>寻找已注册的 Fake 。</p></li> <li><p>接下来，找到实际的绑定。</p></li> <li><p>查找别名，如果找到，重复该绑定过程。</p></li> <li><p>解析为自动加载路径。</p></li> <li><p>回退到 Node.js 原生的 require 方法。</p></li></ol> <h3 id="别名"><a href="#别名" aria-hidden="true" class="header-anchor">#</a> 别名</h3> <p>由于 IoC 容器绑定必须是唯一的，我们使用以下模式来绑定名称： <strong>Project/Scope/Module</strong> 。</p> <p>以 <strong>Adonis/Src/Config</strong> 为例：</p> <ul><li><p>Adonis 是项目名称(也可能是你公司的名称)</p></li> <li><p>Src 是 Scope ，因为这个绑定是核心的一部分(对于自己的包，我们使用 <strong>Addon</strong> 关键字)</p></li> <li><p>Config 是实际的模块名称</p></li></ul> <p>由于有时很难记住并输入完整的命名空间，因此 IoC 容器允许你为它们定义别名。</p> <p>别名是在 start/app.js 文件 aliases 对象中定义的。</p> <blockquote><p>AdonisJs 预设了一些别名，如 Route ，View ，Model 等。但是，你可以覆盖它们，如下所示。</p></blockquote> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>aliases<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  MyRoute<span class="token punctuation">:</span> <span class="token string">'Adonis/Src/Route'</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> Route <span class="token operator">=</span> <span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'MyRoute'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="自动加载"><a href="#自动加载" aria-hidden="true" class="header-anchor">#</a> 自动加载</h3> <p>你还可以定义一个由 IoC 容器自动加载的目录，而不仅仅是将依赖项绑定到 IoC 容器。</p> <p>不用担心，它不会从目录中加载所有文件，而是将目录路径视为依赖项解析过程的一部分。</p> <p>例如，AdonisJs 的 app 的目录定义为 App 命名空间，这意味着你可以 require app 目录中的所有文件而不需要写路径。</p> <p>例如：</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">FooService</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> FooService
</code></pre></div><p>可以被导入</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> Foo <span class="token operator">=</span> <span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'App/Services/Foo'</span><span class="token punctuation">)</span>
</code></pre></div><p>如果没有自动加载，就不得不像这样导入它：
<strong>require('../../Services/Foo')</strong> 。</p> <p>因此，将自动加载视为一种更可读，更一致的方式来处理文件。</p> <h2 id="faq-s"><a href="#faq-s" aria-hidden="true" class="header-anchor">#</a> FAQ's</h2> <ol><li>是否必须绑定 IoC 容器内的所有内容？</li></ol> <p>不需要。当你想要将 library/module 的设置抽象为它自己的东西时，才应该使用IoC容器绑定。此外，当你想要分发依赖关系并希望它们与 AdonisJs 生态系统一起时，请考虑使用<a href="/adonisjs-cn/guides/concept/service-provider.html">服务提供者</a>。</p> <ol start="2"><li>如何模拟绑定？</li></ol> <p>因为 AdonisJs 允许你实现 fakes ，所以不需要模拟绑定。了解更多关于<a href="/adonisjs-cn/guides/testing/fakes.html">fakes</a>。</p> <ol start="3"><li>如何将npm模块包装为服务提供者？</li></ol> <p><a href="/adonisjs-cn/guides/concept/service-provider.html">服务提供者</a>是完整的指南。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后一次更新: </span> <span class="time">6/27/2019, 10:52:35 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/adonisjs-cn/guides/concept/request-lifecycle.html" class="prev">
          Request 生命周期
        </a></span> <span class="next"><a href="/adonisjs-cn/guides/concept/service-provider.html">
          服务提供者
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/adonisjs-cn/assets/js/app.c41742cd.js" defer></script><script src="/adonisjs-cn/assets/js/2.b1db5fd3.js" defer></script><script src="/adonisjs-cn/assets/js/22.6e24fd7a.js" defer></script>
  </body>
</html>
